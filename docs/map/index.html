<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ğŸŒŸkintoneç”¨æ¤œç´¢URLä½œæˆã‚µã‚¤ãƒˆï¼ˆã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼†ãƒªãƒãƒ¼ã‚¹ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰</title>

  <script>
    // Geolocation APIã«å¯¾å¿œã—ã¦ã„ã‚‹
    if (navigator.geolocation) {
      //alert("ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã™");
      getPosition();
    // Geolocation APIã«å¯¾å¿œã—ã¦ã„ãªã„
    } else {
      alert("ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“");
    }

    // ç¾åœ¨åœ°å–å¾—å‡¦ç†
    function getPosition() {
      // ç¾åœ¨åœ°ã‚’å–å¾—
      navigator.geolocation.getCurrentPosition(
        // å–å¾—æˆåŠŸã—ãŸå ´åˆ
        function(position) {
            //alert("ç·¯åº¦:"+position.coords.latitude+",çµŒåº¦"+position.coords.longitude);
            var k = 0.1;
            var lat = position.coords.latitude;
            var lon = position.coords.longitude;
          //https://map.yahooapis.jp/geoapi/V1/reverseGeoCoder?lat=35.68381981&lon=139.77456498&appid=dj0zaiZpPUNteUE3UzlEWmJ0eCZzPWNvbnN1bWVyc2VjcmV0Jng9MTU-
           
            // ã‚¯ãƒ­ã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³ã®åˆ¶ç´„ã§å–å¾—ã§ããªã‹ã£ãŸãƒ»ãƒ»ãƒ»
            //var _url = 'https://map.yahooapis.jp/geoapi/V1/reverseGeoCoder?lat='+ lat +'&lon='+ lon +'&appid=dj0zaiZpPUNteUE3UzlEWmJ0eCZzPWNvbnN1bWVyc2VjcmV0Jng9MTU-';
            var _url = 'https://www.finds.jp/ws/rgeocode.php?lat='+ lat +'&lon='+ lon +'&appid=dj0zaiZpPUNteUE3UzlEWmJ0eCZzPWNvbnN1bWVyc2VjcmV0Jng9MTU-';
            //lat=35.7080677&lon=139.752167  
          //var resp = window.open(_url);
            //console.log(resp);
          
          
            var xhr = new XMLHttpRequest();
            xhr.open('GET', _url, true);
            // If specified, responseType must be empty string or "document"
            xhr.responseType = 'document';
            //xhr.responseType = 'jsonp'; // ğŸ”´ã‚¨ãƒ©ãƒ¼ãƒ»ãƒ»ãƒ»ï¼ˆã‚¯ãƒ­ã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³å¯¾ç­–ã®ã¤ã‚‚ã‚Šã ã£ãŸãŒï¼‰
            // overrideMimeType() can be used to force the response to be parsed as XML
            xhr.overrideMimeType('text/xml');

            xhr.onload = function () 
            {
              if (xhr.readyState === xhr.DONE) {
                if (xhr.status === 200) {
                  
                  console.log(xhr.responseXML.documentElement); //ğŸ”µOK!
                  
                  var éƒ½é“åºœçœŒ = xhr.responseXML.documentElement.getElementsByTagName("pname")[0].innerHTML;
                  var å¸‚åŒºç”ºæ‘ = xhr.responseXML.documentElement.getElementsByTagName("mname")[0].innerHTML;
                  var ç•ªåœ° = xhr.responseXML.documentElement.getElementsByTagName("section")[0].innerHTML;
                  console.log(éƒ½é“åºœçœŒ); //éƒ½é“åºœçœŒ
                  console.log(å¸‚åŒºç”ºæ‘); //å¸‚åŒºç”ºæ‘
                  console.log(ç•ªåœ°); //ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                  
                  var btn = document.createElement("button");
                  btn.setAttribute("id","testButton");
                  btn.type = 'button';
                  btn.textContent = å¸‚åŒºç”ºæ‘;
                  btn.onclick = function(e){
                     console.log(e);
                     console.log(e.target.innerText);
                  };
                  document.body.appendChild(btn); //bodyè¦ç´ ã«è¿½åŠ 
                  
                  
                  console.log(xmlDoc.documentElement);
                  console.log("pname=");
                  console.log(xmlDoc.children);
                  log(xmlDoc.children[0]);
                  //console.log(JSON.stringify(serialize(xmlDoc.children[0]), null, '  '))
                  console.log(xmlDoc.getElementsByTagName("pname"));
                  console.log(xmlDoc.getElementsByTagName("result"));
                  console.log(xmlDoc.getElementsByTagName("rgeocode"));                  
                }
              }
            };
            xhr.send(null);
                                 
            var latMin = position.coords.latitude - k;
            var lonMin = position.coords.longitude - k;
            var latMax = position.coords.latitude + k;
            var lonMax = position.coords.longitude + k;
            //var url = 'https://musashi.cybozu.com/k/2589/?q=f5362384%20%3C=%20%22' + latMin + '%22%20and%20f5362384%20%3E%3D%20%22' + latMax + '%22%20and%20f5362385%20%3E=%20%22' + lonMin + '%22%20and%20f5362385%20%3E%3D%20%22' + lonMax +'%22';
            //https://musashi.cybozu.com/k/2589/?view=5523623&q=f5362384%20%3E=%20%2235.5%22%20and%20f5362384%20%3C=%20%2235.6%22%20and%20f5362385%20%3E=%20%22139.5454822%22#sort_0=f9157&order_0=desc&size=20
            //var url = 'https://musashi.cybozu.com/k/2589/?q=f5362384%20%3C=%20%22' + latMin + '%22%20and%20f5362384%20%3E%3D%20%22' + latMax + '%22%20and%20f5362385%20%3E=%20%22' + lonMin + '%22%20and%20f5362385%20%3E%3D%20%22' + lonMax +'%22';
            //var url = 'https://musashi.cybozu.com/k/2589/?q=f5362384%20%3E=%20%22' + latMin + '%22%20and%20f5362384%20%3C%3D%20%22' + latMax + '%22%20and%20f5362385%20%3E=%20%22' + lonMin + '%22%20and%20f5362385%20%3C%3D%20%22' + lonMax +'%22'; //â—å‹•ã„ãŸ
            //ç¾åœ¨ä½ç½®ã¯URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆlatã€lonï¼‰ã¨ã—ã¦åŸ‹ã‚è¾¼ã‚“ã§ã„ã‚‹ï¼ˆä½•ã‹ã«ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ï¼‰
            var url = 'https://musashi.cybozu.com/k/2589/?lat=' + lat + '&lon=' + lon + '&q=f5362384%20%3E=%20%22' + latMin + '%22%20and%20f5362384%20%3C%3D%20%22' + latMax + '%22%20and%20f5362385%20%3E=%20%22' + lonMin + '%22%20and%20f5362385%20%3C%3D%20%22' + lonMax +'%22';
            //ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            //https://getpocket.com/redirect?url=https%3A%2F%2Fmusashi.cybozu.com%2Fk%2F2589%2F%3Fq%3Df5362384%2520%253C%3D%2520%252235%2522%2520and%2520f5362385%2520%253E%3D%2520%2522135%2522&formCheck=b2e505233ac0857b23be7a01bdce4035
            //https://musashi.cybozu.com/k/2589/?q=f5362384%20%3C=%20%2235%22%20and%20f5362385%20%3E=%20%22135%22
            //https://musashi.cybozu.com/k/2589/?q=f5362384 <= "35" and f5362385 >= "135"
            // https://musashi.cybozu.com/k/2589/?view=5523623&q=f5362384 <= "35.7" and f5362384 >= "35.6" and f5362385 >= "139.5454822"#sort_0=f9157&order_0=desc&size=20
            
            //location.href = url;
        },
        // å–å¾—å¤±æ•—ã—ãŸå ´åˆ
        function(error) {
          switch(error.code) {
            case 1: //PERMISSION_DENIED
              alert("ä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“");
              break;
            case 2: //POSITION_UNAVAILABLE
              alert("ç¾åœ¨ä½ç½®ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");
              break;
            case 3: //TIMEOUT
              alert("ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«ãªã‚Šã¾ã—ãŸ");
              break;
            default:
              alert("ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼(ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:"+error.code+")");
              break;
          }
        }
      );
    }
      /**
      * XML2JSObject
      */
      function serialize(dom) {
        var obj = {
          tagName: dom.tagName,
          attributes: Array.prototype.slice.call(dom.attributes, 0, dom.attributes.length).map(function (attr) {
            return {name: attr.name, value: attr.textContent}
          }),
          children: Array.prototype.map.call(dom.children, function (e) {
            return serialize(e);
          })
        };
        return obj;
      }
      /**
      * ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ­ã‚°é–¢æ•°
      */
      function log(dom, indent) {
        indent = (indent || "") + "  ";
        console.log(indent + dom.tagName, Array.prototype.join.call(dom.attributes, ", "));
        Array.prototype.forEach.call(dom.children || [], function (e) {
          log(e, indent)
        });
      }
  </script>
</head>
<body>
  <h1>ğŸŒŸä½ç½®æƒ…å ±å–å¾—ï¼ˆãƒªãƒãƒ¼ã‚¹ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚‚ã™ã‚‹ï¼‰â‡’kintoneã‚¢ãƒ—ãƒªã§å‘¨è¾ºä½ç½®ã‚’è¡¨ç¤ºã™ã‚‹</h1>
  <button onclick="getPosition();">ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹</button>
</body>
</html>

